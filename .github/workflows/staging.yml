name: Staging Pipeline

on:
  push:
    branches: [ main ]
    paths:
      - 'tf/**'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1

jobs:
  deploy-infrastructure:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3

    - name: Terraform Init
      run: |
        cd tf
        terraform init

    - name: Terraform Plan
      run: |
        cd tf
        terraform plan

    - name: Terraform Apply
      run: |
        cd tf
        terraform apply -auto-approve

    - name: Get Public EC2 IP
      id: get-ip
      run: |
        cd tf
        echo "PUBLIC_IP=$(terraform output -raw public_ec2_ip)" >> $GITHUB_OUTPUT

    # ---------- EMAILS ----------
    - name: Email QA (Success)
      if: success()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USER }}
        password: ${{ secrets.EMAIL_PASS }}
        from: CI Pipeline <${{ secrets.EMAIL_USER }}>
        to: ${{ secrets.QA_EMAIL }}
        subject: Staging Infrastructure Deployed
        body: |
          Staging Infrastructure Deployed Successfully.
          Public EC2 IP: ${{ steps.get-ip.outputs.PUBLIC_IP }}
          URL: http://${{ steps.get-ip.outputs.PUBLIC_IP }}
          Branch: main

    - name: Email Developer (Failure)
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USER }}
        password: ${{ secrets.EMAIL_PASS }}
        from: CI Pipeline <${{ secrets.EMAIL_USER }}>
        to: ${{ secrets.DEV_EMAIL }}
        subject: Staging Pipeline Failed
        body: |
          Pipeline failed on staging.
          Check GitHub Actions logs.
